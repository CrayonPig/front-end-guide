<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>行为监控 | 前端工程化详解</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="前端工程化详解;开箱即用的前端工程化方案;前端代码规范;使用过程中如碰到问题，请到Github进行提问。 https://github.com/CrayonPig/front-end-guide">
    
    <link rel="preload" href="/assets/css/0.styles.ba320c78.css" as="style"><link rel="preload" href="/assets/js/app.9845c54b.js" as="script"><link rel="preload" href="/assets/js/2.bf149dcc.js" as="script"><link rel="preload" href="/assets/js/66.e88792d4.js" as="script"><link rel="prefetch" href="/assets/js/10.a34b3e25.js"><link rel="prefetch" href="/assets/js/11.2deb2e23.js"><link rel="prefetch" href="/assets/js/12.b055d463.js"><link rel="prefetch" href="/assets/js/13.15eb0354.js"><link rel="prefetch" href="/assets/js/14.1fe2b097.js"><link rel="prefetch" href="/assets/js/15.ca8ba03f.js"><link rel="prefetch" href="/assets/js/16.006615b2.js"><link rel="prefetch" href="/assets/js/17.8142e6a4.js"><link rel="prefetch" href="/assets/js/18.f21ee48e.js"><link rel="prefetch" href="/assets/js/19.9a204aa4.js"><link rel="prefetch" href="/assets/js/20.c1ac816c.js"><link rel="prefetch" href="/assets/js/21.28b1eeae.js"><link rel="prefetch" href="/assets/js/22.d2bc1d7a.js"><link rel="prefetch" href="/assets/js/23.36b4b449.js"><link rel="prefetch" href="/assets/js/24.c2ea03d4.js"><link rel="prefetch" href="/assets/js/25.4342eae9.js"><link rel="prefetch" href="/assets/js/26.86530ad8.js"><link rel="prefetch" href="/assets/js/27.9e60f48e.js"><link rel="prefetch" href="/assets/js/28.7eaa8ac7.js"><link rel="prefetch" href="/assets/js/29.f0e3f7ee.js"><link rel="prefetch" href="/assets/js/3.a9215d94.js"><link rel="prefetch" href="/assets/js/30.0f8638cb.js"><link rel="prefetch" href="/assets/js/31.236d5561.js"><link rel="prefetch" href="/assets/js/32.429de332.js"><link rel="prefetch" href="/assets/js/33.fb652ddd.js"><link rel="prefetch" href="/assets/js/34.1b35730b.js"><link rel="prefetch" href="/assets/js/35.06dae4cd.js"><link rel="prefetch" href="/assets/js/36.e0396967.js"><link rel="prefetch" href="/assets/js/37.286f63af.js"><link rel="prefetch" href="/assets/js/38.a0baf9b5.js"><link rel="prefetch" href="/assets/js/39.4b8ec6e7.js"><link rel="prefetch" href="/assets/js/4.b3e978bf.js"><link rel="prefetch" href="/assets/js/40.4f2560db.js"><link rel="prefetch" href="/assets/js/41.e69d5e5e.js"><link rel="prefetch" href="/assets/js/42.92acd231.js"><link rel="prefetch" href="/assets/js/43.15a043bd.js"><link rel="prefetch" href="/assets/js/44.8d0437b9.js"><link rel="prefetch" href="/assets/js/45.636d270c.js"><link rel="prefetch" href="/assets/js/46.c3b2569b.js"><link rel="prefetch" href="/assets/js/47.e5b6a039.js"><link rel="prefetch" href="/assets/js/48.d8c9b083.js"><link rel="prefetch" href="/assets/js/49.980e634b.js"><link rel="prefetch" href="/assets/js/5.e7ef6714.js"><link rel="prefetch" href="/assets/js/50.680b5021.js"><link rel="prefetch" href="/assets/js/51.bf5b8335.js"><link rel="prefetch" href="/assets/js/52.d1453447.js"><link rel="prefetch" href="/assets/js/53.41ad0541.js"><link rel="prefetch" href="/assets/js/54.21ce93bf.js"><link rel="prefetch" href="/assets/js/55.a28d9d7d.js"><link rel="prefetch" href="/assets/js/56.c9f0de25.js"><link rel="prefetch" href="/assets/js/57.25cf4c5d.js"><link rel="prefetch" href="/assets/js/58.23811d0a.js"><link rel="prefetch" href="/assets/js/59.fe1c6294.js"><link rel="prefetch" href="/assets/js/6.5ccff16d.js"><link rel="prefetch" href="/assets/js/60.e5fd74eb.js"><link rel="prefetch" href="/assets/js/61.dcf905ab.js"><link rel="prefetch" href="/assets/js/62.6ceb7a5d.js"><link rel="prefetch" href="/assets/js/63.efe52fef.js"><link rel="prefetch" href="/assets/js/64.b7aa524a.js"><link rel="prefetch" href="/assets/js/65.4b47408d.js"><link rel="prefetch" href="/assets/js/67.4612fbbc.js"><link rel="prefetch" href="/assets/js/68.d6714dad.js"><link rel="prefetch" href="/assets/js/69.c9df74b9.js"><link rel="prefetch" href="/assets/js/7.b91df557.js"><link rel="prefetch" href="/assets/js/70.ea87a776.js"><link rel="prefetch" href="/assets/js/71.16bb7164.js"><link rel="prefetch" href="/assets/js/72.c8fee018.js"><link rel="prefetch" href="/assets/js/73.af3845a1.js"><link rel="prefetch" href="/assets/js/74.543675c0.js"><link rel="prefetch" href="/assets/js/75.5756abdc.js"><link rel="prefetch" href="/assets/js/76.f79c415d.js"><link rel="prefetch" href="/assets/js/77.8ced90d4.js"><link rel="prefetch" href="/assets/js/78.51316985.js"><link rel="prefetch" href="/assets/js/79.1fbab876.js"><link rel="prefetch" href="/assets/js/8.7d7668f5.js"><link rel="prefetch" href="/assets/js/9.c7a4347c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ba320c78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端工程化详解</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/project/" class="nav-link router-link-active">
  工程化详解
</a></div><div class="nav-item"><a href="/monitor/" class="nav-link">
  前端监控系统
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  代码规范
</a></div><div class="nav-item"><a href="https://github.com/CrayonPig/front-end-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/project/" class="nav-link router-link-active">
  工程化详解
</a></div><div class="nav-item"><a href="/monitor/" class="nav-link">
  前端监控系统
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  代码规范
</a></div><div class="nav-item"><a href="https://github.com/CrayonPig/front-end-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/project/" aria-current="page" class="sidebar-link">简介</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>项目立项</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/setUp/flow.html" class="sidebar-link">产研流程</a></li><li><a href="/project/setUp/documents.html" class="sidebar-link">知识协同</a></li><li><a href="/project/setUp/selection.html" class="sidebar-link">技术选型</a></li><li><a href="/project/setUp/standard.html" class="sidebar-link">交付标准</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码质量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/codeQuality/guide.html" class="sidebar-link">统一规范</a></li><li><a href="/project/codeQuality/lint.html" class="sidebar-link">规范工具</a></li><li><a href="/project/codeQuality/ts.html" class="sidebar-link">类型约束</a></li><li><a href="/project/codeQuality/version.html" class="sidebar-link">版本控制</a></li><li><a href="/project/codeQuality/codeReview.html" class="sidebar-link">Code Review</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工程搭建</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/build/build.html" class="sidebar-link">构建工具</a></li><li><a href="/project/build/cli.html" class="sidebar-link">脚手架</a></li><li><a href="/project/build/ast.html" class="sidebar-link">AST</a></li><li><a href="/project/build/debug.html" class="sidebar-link">代码调试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>组件建设</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/component/module.html" class="sidebar-link">组件化</a></li><li><a href="/project/component/guide.html" class="sidebar-link">设计规范</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>测试保障</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/test/unit.html" class="sidebar-link">单元测试</a></li><li><a href="/project/test/integration.html" class="sidebar-link">集成测试</a></li><li><a href="/project/test/e2e.html" class="sidebar-link">端到端测试(E2E)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CI/CD</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/deploy/" class="sidebar-link">简介</a></li><li><a href="/project/deploy/basic.html" class="sidebar-link">传统部署</a></li><li><a href="/project/deploy/container.html" class="sidebar-link">容器化部署</a></li><li><a href="/project/deploy/githubActions.html" class="sidebar-link">GitHub Actions</a></li><li><a href="/project/deploy/gitlabCI.html" class="sidebar-link">GitLab Pipelines</a></li><li><a href="/project/deploy/mode.html" class="sidebar-link">版本部署方式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>整体优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/optimize/build.html" class="sidebar-link">构建优化</a></li><li><a href="/project/optimize/volume.html" class="sidebar-link">体积优化</a></li><li><a href="/project/optimize/performance.html" class="sidebar-link">性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>安全保障</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/security/attack.html" class="sidebar-link">常见攻击</a></li><li><a href="/project/security/resource.html" class="sidebar-link">资源劫持</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>页面监控</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/monitor/performance.html" class="sidebar-link">性能监控</a></li><li><a href="/project/monitor/error.html" class="sidebar-link">异常监控</a></li><li><a href="/project/monitor/blankScreen.html" class="sidebar-link">白屏监控</a></li><li><a href="/project/monitor/jank.html" class="sidebar-link">卡顿监控</a></li><li><a href="/project/monitor/behaviour.html" aria-current="page" class="active sidebar-link">行为监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#pv、uv" class="sidebar-link">PV、UV</a></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#页面停留时长" class="sidebar-link">页面停留时长</a></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#事件监听" class="sidebar-link">事件监听</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#鼠标事件" class="sidebar-link">鼠标事件</a></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#键盘事件" class="sidebar-link">键盘事件</a></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#滚动事件" class="sidebar-link">滚动事件</a></li></ul></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#ajax监听" class="sidebar-link">AJAX监听</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#重写xmlhttprequest" class="sidebar-link">重写XMLHttpRequest</a></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#劫持fetch" class="sidebar-link">劫持Fetch</a></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#axios-拦截器" class="sidebar-link">axios 拦截器</a></li></ul></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#页面路径" class="sidebar-link">页面路径</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#利用历史记录api" class="sidebar-link">利用历史记录API</a></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#利用路由框架" class="sidebar-link">利用路由框架</a></li><li class="sidebar-sub-header"><a href="/project/monitor/behaviour.html#利用页面加载事件" class="sidebar-link">利用页面加载事件</a></li></ul></li></ul></li><li><a href="/project/monitor/report.html" class="sidebar-link">数据上报</a></li><li><a href="/project/monitor/sentry.html" class="sidebar-link">解决方案Sentry</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>跨平台开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/hybrid/" class="sidebar-link">简介</a></li><li><a href="/project/hybrid/web.html" class="sidebar-link">Web渲染</a></li><li><a href="/project/hybrid/native.html" class="sidebar-link">原生渲染</a></li><li><a href="/project/hybrid/canvas.html" class="sidebar-link">自绘制引擎渲染</a></li><li><a href="/project/hybrid/use.html" class="sidebar-link">技术选型</a></li><li><a href="/project/hybrid/miniProgram.html" class="sidebar-link">小程序</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>微前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/micro/" class="sidebar-link">简介</a></li><li><a href="/project/micro/use.html" class="sidebar-link">技术选型</a></li><li><a href="/project/micro/reuse.html" class="sidebar-link">公共代码复用</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="行为监控"><a href="#行为监控" class="header-anchor">#</a> 行为监控</h1> <p>监控用户行为是为了了解用户在网站或应用程序中的行为和需求，从而优化用户体验和提高业务转化率。通过监控用户行为，我们可以收集和分析用户的操作和行为数据，帮助我们发现网站或应用程序的问题和瓶颈，了解用户的需求和偏好，从而针对性地改进网站或应用程序的设计和功能，提高用户的满意度和忠诚度，促进业务的增长。</p> <p>具体来说，通过用户行为监控可以实现以下几个方面的目标：</p> <ol><li>收集用户行为数据。通过监控用户的点击、浏览、搜索、购买等行为，我们可以收集大量的用户数据，从而了解用户的兴趣、偏好、行为路径、停留时间等信息，为我们提供优化网站或应用程序的基础数据。</li> <li>优化用户体验。通过分析用户的行为和反馈，我们可以发现网站或应用程序的问题和瓶颈，并及时改进和优化，提高用户的满意度和忠诚度，减少用户流失率。</li> <li>提高业务转化率。通过分析用户的购买、注册、订阅等行为，我们可以了解用户的需求和行为习惯，从而优化网站或应用程序的设计和功能，提高业务的转化率和收入。</li> <li>精准营销和个性化推荐。通过分析用户的行为和兴趣，我们可以实现精准营销和个性化推荐，为用户提供更优质的服务和产品，提高用户的满意度和忠诚度，促进业务的增长。</li></ol> <h2 id="pv、uv"><a href="#pv、uv" class="header-anchor">#</a> PV、UV</h2> <p>PV（Page View）和 UV（Unique Visitor）是衡量网站流量和用户访问量的两个指标。PV指的是页面浏览量，即网站的访问量；UV指的是独立访客数量，即访问网站的独立用户数。</p> <p>我们可以通过 document.referrer 获取来源页面信息，可以判断是否为新用户。同时，通过 Cookie 和 LocalStorage 等机制可以记录用户访问时间和访问次数等信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 记录 PV</span>
<span class="token keyword">var</span> pvCount <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'pvCount'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
pvCount<span class="token operator">++</span><span class="token punctuation">;</span>
localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'pvCount'</span><span class="token punctuation">,</span> pvCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 记录 UV</span>
<span class="token keyword">var</span> uvCount <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'uvCount'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span>referrer <span class="token operator">||</span> document<span class="token punctuation">.</span>referrer<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> location<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  uvCount<span class="token operator">++</span><span class="token punctuation">;</span>
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'uvCount'</span><span class="token punctuation">,</span> uvCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在实际应用中，为了保证数据准确性和安全性，需要考虑用户隐私和数据保护等问题，每进入页面一次，算一次PV，后端根据业务逻辑，如使用用户id等计算UV。</p> <h2 id="页面停留时长"><a href="#页面停留时长" class="header-anchor">#</a> 页面停留时长</h2> <p>当用户打开页面时，记录一个开始时间点；当用户关闭页面或跳转到其他页面时，记录一个结束时间点，然后计算两者之差即为页面停留时长。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录开始时间</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeunload'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> endTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录结束时间</span>
  <span class="token keyword">var</span> stayTime <span class="token operator">=</span> endTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span> <span class="token comment">// 计算页面停留时长</span>
  <span class="token comment">// 将数据传递给后端进行处理或记录到本地</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用框架时，可以利用框架自身的生命周期或路由守卫来计算时间点，如vue <code>beforeDestroy</code>，react <code>componentWillUnmount</code></p> <h2 id="事件监听"><a href="#事件监听" class="header-anchor">#</a> 事件监听</h2> <p>用户事件可大致分为鼠标事件、键盘事件、滚动事件三类，每种类型的操作行为又可以细分出很多子类。</p> <h3 id="鼠标事件"><a href="#鼠标事件" class="header-anchor">#</a> 鼠标事件</h3> <p>鼠标事件包含单击、双击、按下、松开、滑动等，可以通过，click、dbclick、mousedown、mouseup、mousemove等事件监听。除了需要记录鼠标事件的操作类型，还应该添加鼠标操作的关键信息，比如单机的按键是左键还是右键，触发单击事件的DOM节点类型。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 定义一个对象，用于记录鼠标操作的信息</span>
<span class="token keyword">var</span> mouseEventInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">eventType</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>  <span class="token comment">// 鼠标事件类型</span>
  <span class="token literal-property property">buttonType</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 鼠标按键类型</span>
  <span class="token literal-property property">targetNode</span><span class="token operator">:</span> <span class="token string">''</span>  <span class="token comment">// 触发事件的DOM节点类型</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 获取目标节点的类型</span>
<span class="token keyword">function</span> <span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> target<span class="token punctuation">.</span>nodeName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听鼠标事件</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 记录鼠标事件类型</span>
  mouseEventInfo<span class="token punctuation">.</span>eventType <span class="token operator">=</span> <span class="token string">'click'</span><span class="token punctuation">;</span>

  <span class="token comment">// 记录鼠标按键类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'left'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'middle'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'right'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 记录触发事件的DOM节点类型</span>
  mouseEventInfo<span class="token punctuation">.</span>targetNode <span class="token operator">=</span> <span class="token function">getNodeType</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 发送数据到后端，可根据需求自定义发送的数据格式</span>
  <span class="token function">sendDataToBackend</span><span class="token punctuation">(</span>mouseEventInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dblclick'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 记录鼠标事件类型</span>
  mouseEventInfo<span class="token punctuation">.</span>eventType <span class="token operator">=</span> <span class="token string">'dblclick'</span><span class="token punctuation">;</span>

  <span class="token comment">// 记录鼠标按键类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'left'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'middle'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'right'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 记录触发事件的DOM节点类型</span>
  mouseEventInfo<span class="token punctuation">.</span>targetNode <span class="token operator">=</span> <span class="token function">getNodeType</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 发送数据到后端，可根据需求自定义发送的数据格式</span>
  <span class="token function">sendDataToBackend</span><span class="token punctuation">(</span>mouseEventInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 记录鼠标事件类型</span>
  mouseEventInfo<span class="token punctuation">.</span>eventType <span class="token operator">=</span> <span class="token string">'mousedown'</span><span class="token punctuation">;</span>

  <span class="token comment">// 记录鼠标按键类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'left'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'middle'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mouseEventInfo<span class="token punctuation">.</span>buttonType <span class="token operator">=</span> <span class="token string">'right'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 记录触发事件的DOM节点类型</span>
  mouseEventInfo<span class="token punctuation">.</span>targetNode <span class="token operator">=</span> <span class="token function">getNodeType</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 发送数据到后端，可根据需求自定义发送的数据格式</span>
  <span class="token function">sendDataToBackend</span><span class="token punctuation">(</span>mouseEventInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><h3 id="键盘事件"><a href="#键盘事件" class="header-anchor">#</a> 键盘事件</h3> <p>键盘事件可以分为按下和松开两类，可以通过keydown和keyup事件来监听。当用户在页面上按下键盘时，会触发keydown事件；当用户松开键盘时，会触发keyup事件。</p> <p>类似于鼠标事件，我们也可以通过事件监听器来监控键盘事件。同样地，在事件回调函数中，我们可以记录下用户按下的键盘键码、触发事件的DOM节点等信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 添加键盘事件监听器</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 记录键盘按下事件相关信息</span>
  <span class="token keyword">var</span> key <span class="token operator">=</span> event<span class="token punctuation">.</span>keyCode <span class="token operator">||</span> event<span class="token punctuation">.</span>which<span class="token punctuation">;</span>
  <span class="token keyword">var</span> target <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'keyboard'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">'keydown'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> key<span class="token punctuation">,</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> target<span class="token punctuation">,</span>
    <span class="token literal-property property">timestamp</span><span class="token operator">:</span> timestamp
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 发送数据到后台</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 记录键盘松开事件相关信息</span>
  <span class="token keyword">var</span> key <span class="token operator">=</span> event<span class="token punctuation">.</span>keyCode <span class="token operator">||</span> event<span class="token punctuation">.</span>which<span class="token punctuation">;</span>
  <span class="token keyword">var</span> target <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'keyboard'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">'keyup'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> key<span class="token punctuation">,</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> target<span class="token punctuation">,</span>
    <span class="token literal-property property">timestamp</span><span class="token operator">:</span> timestamp
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 发送数据到后台</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>键盘事件可能会被浏览器默认处理，例如浏览器可能会响应用户的键盘快捷键，从而导致我们无法正确地获取到用户的按键信息。</p></div> <h3 id="滚动事件"><a href="#滚动事件" class="header-anchor">#</a> 滚动事件</h3> <p>滚动事件较为简单，仅需监听scroll事件，在回调函数中，可以通过获取scrollTop值和页面高度等信息，计算出用户的访问深度和停留时长。同时，也可以记录滚动过程中的一些关键信息，比如滚动的方向和速度等，以便进一步分析用户的行为。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> startScrollTop <span class="token operator">=</span> window<span class="token punctuation">.</span>pageYOffset<span class="token punctuation">;</span>
<span class="token keyword">let</span> startVisibleHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token keyword">let</span> startTotalHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> currentTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentScrollTop <span class="token operator">=</span> window<span class="token punctuation">.</span>pageYOffset<span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentVisibleHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentTotalHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span>
  
  <span class="token comment">// 计算停留时长和访问深度</span>
  <span class="token keyword">let</span> stayTime <span class="token operator">=</span> currentTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
  <span class="token keyword">let</span> scrollDepth <span class="token operator">=</span> currentScrollTop <span class="token operator">+</span> currentVisibleHeight<span class="token punctuation">;</span>

  <span class="token comment">// 记录滚动方向和速度</span>
  <span class="token keyword">let</span> direction <span class="token operator">=</span> currentScrollTop <span class="token operator">&gt;</span> startScrollTop <span class="token operator">?</span> <span class="token string">'down'</span> <span class="token operator">:</span> <span class="token string">'up'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> speed <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>currentScrollTop <span class="token operator">-</span> startScrollTop<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>currentTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 记录关键信息</span>
  <span class="token keyword">let</span> eventInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'scroll'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">direction</span><span class="token operator">:</span> direction<span class="token punctuation">,</span>
    <span class="token literal-property property">speed</span><span class="token operator">:</span> speed<span class="token punctuation">,</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span>
    <span class="token literal-property property">stayTime</span><span class="token operator">:</span> stayTime<span class="token punctuation">,</span>
    <span class="token literal-property property">scrollDepth</span><span class="token operator">:</span> scrollDepth<span class="token punctuation">,</span>
    <span class="token literal-property property">scrollTop</span><span class="token operator">:</span> currentScrollTop<span class="token punctuation">,</span>
    <span class="token literal-property property">visibleHeight</span><span class="token operator">:</span> currentVisibleHeight<span class="token punctuation">,</span>
    <span class="token literal-property property">totalHeight</span><span class="token operator">:</span> currentTotalHeight
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 上报数据</span>
  <span class="token function">report</span><span class="token punctuation">(</span>eventInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新起始时间和位置信息</span>
  startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
  startScrollTop <span class="token operator">=</span> currentScrollTop<span class="token punctuation">;</span>
  startVisibleHeight <span class="token operator">=</span> currentVisibleHeight<span class="token punctuation">;</span>
  startTotalHeight <span class="token operator">=</span> currentTotalHeight<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="ajax监听"><a href="#ajax监听" class="header-anchor">#</a> AJAX监听</h2> <p>Ajax 请求包含请求的发起与取消两类，可以通过重写XMLHttpRequest和Fetch方法采集关键信息。如果使用Axios等第三方请求库，可以直接使用相应的拦截器采集信息。如果后端服务提供了根据UUID查询请求详情的功能，那么只需要简单手机请求的地址、方法和UUID即可。</p> <h3 id="重写xmlhttprequest"><a href="#重写xmlhttprequest" class="header-anchor">#</a> 重写XMLHttpRequest</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> _XMLHttpRequest <span class="token operator">=</span> window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">XMLHttpRequest</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'loadstart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// HTTP 请求发出</span>
    <span class="token keyword">const</span> requestInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> xhr<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> xhr<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">startTime</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将请求信息存储起来，比如通过发送到后端服务器，或者存储在本地缓存中等。</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求中止</span>
    <span class="token keyword">const</span> requestInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> xhr<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> xhr<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">abortTime</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">abortReason</span><span class="token operator">:</span> <span class="token string">'用户取消请求'</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将请求信息存储起来，比如通过发送到后端服务器，或者存储在本地缓存中等。</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求失败</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求成功完成</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求超时</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'loadend'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求完成，不管成功或失败</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="劫持fetch"><a href="#劫持fetch" class="header-anchor">#</a> 劫持Fetch</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> _fetch <span class="token operator">=</span> window<span class="token punctuation">.</span>fetch<span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">fetch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_fetch</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在请求成功时处理相关逻辑，比如记录请求时间、请求返回数据等信息</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在请求失败时处理相关逻辑，比如记录请求失败原因等信息</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="axios-拦截器"><a href="#axios-拦截器" class="header-anchor">#</a> axios 拦截器</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token comment">// 添加请求拦截器</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在发送请求之前做些什么</span>
  config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authorization <span class="token operator">=</span> <span class="token string">'Bearer '</span> <span class="token operator">+</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 对请求错误做些什么</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加响应拦截器</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 对响应数据做点什么</span>
  <span class="token keyword">return</span> response<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 对响应错误做点什么</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="页面路径"><a href="#页面路径" class="header-anchor">#</a> 页面路径</h2> <p>页面路径监控是指在用户使用网站或应用时，对用户浏览页面的路径进行监控和记录。这个过程通常与用户的点击行为、页面跳转、页面加载等操作一起上报，来优化用户体验和提升产品质量。</p> <h3 id="利用历史记录api"><a href="#利用历史记录api" class="header-anchor">#</a> 利用历史记录API</h3> <p>浏览器提供了历史记录API，可以通过监听该API的事件，获取用户的浏览路径。当用户访问新的页面或触发浏览器前进/后退按钮时，就会触发历史记录API的相关事件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'页面路径监控：'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'页面路径监控：'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>newURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="利用路由框架"><a href="#利用路由框架" class="header-anchor">#</a> 利用路由框架</h3> <p>路由框架可以方便地管理页面路径，并提供了相应的事件钩子。一般来说，路由框架的事件钩子包括页面跳转前的钩子、页面跳转后的钩子等，可以通过这些钩子来获取用户的浏览路径。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'页面路径监控：'</span><span class="token punctuation">,</span> to<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="利用页面加载事件"><a href="#利用页面加载事件" class="header-anchor">#</a> 利用页面加载事件</h3> <p>当页面加载完成后，可以通过记录当前页面的路径来实现页面路径监控。通常使用window.onload事件来监听页面加载完成的时机。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'页面路径监控：'</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/project/monitor/jank.html" class="prev">
        卡顿监控
      </a></span> <span class="next"><a href="/project/monitor/report.html">
        数据上报
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9845c54b.js" defer></script><script src="/assets/js/2.bf149dcc.js" defer></script><script src="/assets/js/66.e88792d4.js" defer></script>
  </body>
</html>
